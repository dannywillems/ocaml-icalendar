################################################################################
SRC_DIR			= src
################################################################################

################################################################################
ICAL_FILE		= $(SRC_DIR)/icalendar.ml
ICAL_CMO		= $(ICAL_FILE:.ml=.cmo)
ICAL_MLI		= $(ICAL_FILE:.ml=.cmi)
ICAL_CMI		= $(ICAL_FILE:.ml=.cmi)
################################################################################

################################################################################
PARSER_FILE		= $(SRC_DIR)/parser.mly
PARSER_MLI_FILE	= $(PARSER_FILE:.mly=.mli)
PARSER_CMI_FILE	= $(PARSER_FILE:.mly=.cmi)
PARSER_CMO_FILE	= $(PARSER_FILE:.mly=.cmo)
PARSER_ML_FILE	= $(PARSER_FILE:.mly=.ml)
CC_PARSER		= menhir
################################################################################

################################################################################
LEXER_FILE		= $(SRC_DIR)/lexer.mll
LEXER_ML_FILE	= $(LEXER_FILE:.mll=.ml)
LEXER_CMO_FILE	= $(LEXER_FILE:.mll=.cmo)
LEXER_CMI_FILE	= $(LEXER_FILE:.mll=.cmi)
CC_LEXER		= ocamllex
################################################################################

################################################################################
TEST_DIR		= test
TEST_FILE		= $(TEST_DIR)/test.ml
TEST_CMO		= $(TEST_FILE:.ml=.cmo)
TEST_CMI		= $(TEST_FILE:.ml=.cmi)
TEST_EXE		= test.out
################################################################################

################################################################################
CC_CAML			= ocamlc
################################################################################

################################################################################
all: parser lexer compile
################################################################################

################################################################################
parser:
	$(CC_PARSER) $(PARSER_FILE)

lexer:
	$(CC_LEXER) $(LEXER_FILE)
################################################################################

################################################################################
compile: $(ICAL_CMI) $(ICAL_CMO) $(PARSER_CMI_FILE) $(PARSER_CMO_FILE) $(LEXER_CMO_FILE)

$(SRC_DIR)/%.cmo: $(SRC_DIR)/%.ml
	$(CC_CAML) -I $(SRC_DIR) -c -o $@ $<

$(SRC_DIR)/%.cmi: $(SRC_DIR)/%.mli
	$(CC_CAML) -I $(SRC_DIR) -c -o $@ $<
################################################################################

################################################################################
test: all
	$(CC_CAML) -I $(SRC_DIR) -o $(TEST_EXE) $(ICAL_CMO) $(LEXER_CMO_FILE) $(PARSER_CMO_FILE) $(TEST_FILE)

clean_test:
	$(RM) $(TEST_CMI) $(TEST_CMO)

fclean_test: clean_test
	$(RM) $(TEST_EXE)
################################################################################

################################################################################
clean:
	$(RM) $(PARSER_CMI_FILE) $(PARSER_CMO_FILE) $(PARSER_MLI_FILE) $(PARSER_ML_FILE)
	$(RM) $(LEXER_CMO_FILE) $(LEXER_ML_FILE) $(LEXER_CMI_FILE)
	$(RM) $(ICAL_CMO) $(ICAL_CMI)
################################################################################
